name: Create GitHub Release

on:
  workflow_run:
    workflows: ["Build and Create ZIP"]
    types:
      - completed

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: チェックアウトリポジトリ
        uses: actions/checkout@v3

      - name: アーティファクトをダウンロード
        uses: actions/download-artifact@v3
        with:
          name: build-artifact
          path: "D:\a\VRChat_Screenshot_Discord\VRChat_Screenshot_Discord\downloaded-artifacts"  # Windows絶対パス

      - name: ダウンロードしたZIPファイルを確認
        run: |
          dir "D:\a\VRChat_Screenshot_Discord\VRChat_Screenshot_Discord\downloaded-artifacts"

      - name: タグの作成
        shell: bash
        run: |
          ZIP_NAME=$(ls "D:\a\VRChat_Screenshot_Discord\VRChat_Screenshot_Discord\downloaded-artifacts\*.zip" | xargs -n 1 basename)
          VERSION=$(echo $ZIP_NAME | sed 's/VSD-VRChatScreenshotDiscord_V\(.*\).zip/\1/')

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -a "$VERSION" -m "Version $VERSION"
          git push origin "$VERSION"

          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: GitHubリリースを作成
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: リリース ${{ env.VERSION }}
          body: |
            **リリースノート**
            - バージョン: **${{ env.VERSION }}**
            - 変更点:
              - 安定性が向上しました。
              - 既知の問題を修正しました。
          draft: false
          prerelease: false

      - name: ZIPファイルをリリースにアップロード
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: "D:\a\VRChat_Screenshot_Discord\VRChat_Screenshot_Discord\downloaded-artifacts\${{ env.ZIP_NAME }}"
          asset_name: ${{ env.ZIP_NAME }}
          asset_content_type: application/zip
